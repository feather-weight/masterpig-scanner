<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MasterPig Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h2>MasterPig Scanner</h2>
  <div class="grid">
    <div class="stat">
      <h4>Scan Stats</h4>
      <ul id="stats-list"></ul>
    </div>
    <div class="stat">
      <h4>Recent Usage</h4>
      <ul id="recent-list"></ul>
    </div>
    <div class="stat">
      <h4>Thresholds (addresses with tx count &gt; N)</h4>
      <ul id="thresholds-list"></ul>
    </div>
    <div>
      <canvas id="bucketChart"></canvas>
    </div>
  </div>

  <script>
    Chart.defaults.color = '#999';
    Chart.defaults.font.family = 'Courier New, monospace';

    async function fetchMetrics(){
      const r = await fetch('/metrics');
      return await r.json();
    }

    async function fetchStats(){
      const r = await fetch('/stats');
      return await r.json();
    }

    function updateRecent(list, recent){
      list.innerHTML = '';
      for(const [k,v] of Object.entries(recent)){
        const li = document.createElement('li');
        li.textContent = `${k}: active=${v.active ?? v} with_balance=${v.with_balance ?? 0}`;
        list.appendChild(li);
      }
    }

    function updateThresholds(list, thr){
      list.innerHTML = '';
      Object.keys(thr).sort((a,b)=>{
        const na = parseInt(a.split('_')[1]); const nb = parseInt(b.split('_')[1]);
        return na - nb;
      }).forEach(k=>{
        const li = document.createElement('li');
        li.textContent = `${k.replace('gt_','> ')}: ${thr[k]}`;
        list.appendChild(li);
      });
    }

    function updateStats(list, stats){
      list.innerHTML = '';
      for(const [k,v] of Object.entries(stats)){
        const li = document.createElement('li');
        li.textContent = `${k}: ${v}`;
        list.appendChild(li);
      }
    }

    let chart;
    function updateBucketsChart(ctx, buckets){
      const labels = [];
      const data = [];
      const grans = ['minute','hour','day','week','month','year'];
      grans.forEach(g=>{
        if(buckets[g]){
          labels.push(g);
          data.push(buckets[g].addresses_scanned ?? 0);
        }
      });
      if(chart){ chart.destroy(); }
      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Addresses scanned (latest bucket)',
            data,
            backgroundColor: '#cc33cc',
            borderColor: '#cc33cc'
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: true } },
          scales: {
            x: { ticks: { color: '#999' }, grid: { color: 'rgba(204,51,204,0.3)' } },
            y: { ticks: { color: '#999' }, grid: { color: 'rgba(204,51,204,0.3)' } }
          }
        }
      });
    }

    async function loop(){
      try{
        const [m, s] = await Promise.all([fetchMetrics(), fetchStats()]);
        updateRecent(document.getElementById('recent-list'), m.recent_usage || {});
        updateThresholds(document.getElementById('thresholds-list'), m.thresholds || {});
        updateBucketsChart(document.getElementById('bucketChart'), m.buckets || {});
        updateStats(document.getElementById('stats-list'), s || {});
      }catch(e){ console.error(e); }
      setTimeout(loop, 5000);
    }
    function typeWriter(el, text, i=0){
      if(i < text.length){
        el.textContent += text.charAt(i);
        setTimeout(()=>typeWriter(el, text, i+1), 100);
      }
    }

    window.addEventListener('load', () => {
      const title = document.querySelector('h2');
      const txt = title.textContent;
      title.textContent = '';
      typeWriter(title, txt);
      loop();
    });
  </script>
</body>
</html>
